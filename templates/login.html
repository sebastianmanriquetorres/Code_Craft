<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login & Registro</title>
  <link rel="icon" href="./static/img/head.png" sizes="32x32" type="image/png">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- SweetAlert2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* (opcional) estilo para deshabilitar el bot√≥n mientras bloqueado */
    .btn[disabled] { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="shooting-stars"></div>

  <style>
  /* üåå Fondo espacial */
  body {
    background: radial-gradient(circle at bottom, #001d3d 0%, #000814 100%);
    overflow: hidden;
    min-height: 100vh;
    margin: 0;
    font-family: 'Montserrat', sans-serif;
    position: relative;
    color: #fff;
  }

  /* Contenedores */
  .stars, .shooting-stars {
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0; left: 0;
    pointer-events: none;
    z-index: -1;
  }

  /* ‚ú® Estrellas */
  .star {
    position: absolute;
    border-radius: 50%;
    background: white;
    opacity: 0.8;
    box-shadow: 0 0 8px white, 0 0 15px #4fc3f7;
    animation: blink 2s infinite ease-in-out alternate;
  }

  @keyframes blink {
    0%, 100% { opacity: 0.3; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.6); }
  }

  /* üå† Estrella fugaz */
  .shooting-star {
    position: absolute;
    width: 120px;
    height: 2px;
    background: linear-gradient(90deg, white, transparent);
    opacity: 0;
  }

  /* Movimiento fugaz de izquierda a derecha */
  @keyframes shoot-left-right {
    0% {
      opacity: 0;
      transform: translateX(-200px) rotate(-15deg) scaleX(0.5);
    }
    10% { opacity: 1; }
    70% {
      opacity: 0.9;
      transform: translateX(110vw) rotate(-15deg) scaleX(1);
    }
    100% {
      opacity: 0;
      transform: translateX(120vw) rotate(-15deg) scaleX(0.5);
    }
  }

  /* Movimiento fugaz de derecha a izquierda */
  @keyframes shoot-right-left {
    0% {
      opacity: 0;
      transform: translateX(200px) rotate(15deg) scaleX(0.5);
    }
    10% { opacity: 1; }
    70% {
      opacity: 0.9;
      transform: translateX(-110vw) rotate(15deg) scaleX(1);
    }
    100% {
      opacity: 0;
      transform: translateX(-120vw) rotate(15deg) scaleX(0.5);
    }
  }
</style>

<div class="stars"></div>
<div class="shooting-stars"></div>

<script>
  // ‚≠ê Generar estrellas
  const starsContainer = document.querySelector('.stars');
  for (let i = 0; i < 100; i++) { 
    const star = document.createElement('div');
    star.classList.add('star');
    const size = Math.random() * 3 + 2; 
    star.style.width = `${size}px`;
    star.style.height = `${size}px`;
    star.style.top = `${Math.random() * 100}%`;
    star.style.left = `${Math.random() * 100}%`;
    star.style.animationDelay = `${Math.random() * 3}s`;
    starsContainer.appendChild(star);
  }

  // üå† Generar estrellas fugaces
  function createShootingStar() {
    const shootingStarsContainer = document.querySelector('.shooting-stars');
    const shootingStar = document.createElement('div');
    shootingStar.classList.add('shooting-star');

    // Posici√≥n vertical aleatoria
    shootingStar.style.top = `${Math.random() * 70}%`;

    // Direcci√≥n aleatoria
    const direction = Math.random() > 0.5 ? 'left-right' : 'right-left';
    shootingStar.style.animationName = `shoot-${direction}`;

    // Velocidad aleatoria
    const duration = 1.5 + Math.random() * 2;
    shootingStar.style.animationDuration = `${duration}s`;

    shootingStarsContainer.appendChild(shootingStar);

    // Remover despu√©s de animar
    setTimeout(() => {
      shootingStar.remove();
    }, duration * 1000);
  }

  // üå† Lanzar estrellas fugaces cada cierto tiempo
  setInterval(createShootingStar, 4000);
</script>



  <main class="auth">
    <div class="auth__card" id="authCard">
      <!-- Columna: formularios -->
      <div class="auth__forms">
        <!-- Login -->
        <form method="POST" action="/login" class="form form--login" id="loginForm" autocomplete="on">
          <h2 class="form__title">Iniciar sesi√≥n</h2>

          <div class="input">
            <input type="text" name="usuario" id="loginUsuario" required />
            <label for="loginUsuario">Usuario o Correo</label>
            <span class="input__bar"></span>
          </div>

       <div class="input" style="position: relative;">
  <input type="password" name="password" id="loginPassword" minlength="6" required />
  <label for="loginPassword">Contrase√±a</label>
  <span class="input__bar"></span>

  <!-- Bot√≥n del ojo -->
  <button
    type="button"
    id="togglePassword"
    aria-pressed="false"
    aria-label="Mostrar contrase√±a"
    title="Mostrar contrase√±a"
    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
           background: none; border: none; padding: 0; cursor: pointer; display: inline-flex; align-items:center;">
    <!-- Ojo abierto (visible por defecto) -->
    <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
         style="display: block; pointer-events: none;">
      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" fill="none" stroke="#666" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="12" cy="12" r="3" fill="none" stroke="#666" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>

    <!-- Ojo cerrado (oculto por defecto) -->
    <svg class="eye-closed" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
         style="display: none; pointer-events: none;">
      <path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a21.82 21.82 0 0 1 5.17-6.88" fill="none" stroke="#666" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" fill="none" stroke="#666" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="1" y1="1" x2="23" y2="23" stroke="#666" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
  </button>
</div>





          <button class="btn" type="submit" id="loginBtn">Entrar</button>

          <p class="form__switch">
            ¬øNo tienes cuenta?
            <button class="link link--btn" type="button" data-switch="signup">Crear cuenta</button>
          </p>
 <hr class="linea-bonita">
<style>
  .linea-bonita {
  border: none; /* quitamos el borde por defecto */
  height: 3px; /* grosor de la l√≠nea */
  background: linear-gradient(to right, #4f46e5, #06b6d4); /* degradado bonito */
  border-radius: 5px; /* esquinas redondeadas */
  margin: 20px 0; /* espacio arriba y abajo */
}

</style>
          <p class="form__switch">
            ¬øOlvidaste tu contrase√±a?
          <!-- Bot√≥n que redirige -->
          <button class="link link--btn" type="button" id="btnCambiarPass">
            Cambiar contrase√±a
          </button>
          </p>

<script>
  // Script para redirigir al hacer clic
  document.getElementById("btnCambiarPass").addEventListener("click", () => {
    window.location.href = "/cambiar_contrase√±a";
  });
</script>
        </form>

        <!-- Registro (sin cambios importantes) -->
        <form method="POST" action="/registro" class="form form--signup" id="signupForm" autocomplete="on">
          <h2 class="form__title">Crear cuenta</h2>
          <div class="form__grid">
            <div class="input">
              <input type="text" name="nombre" id="signupFirstName" minlength="2" required />
              <label for="signupFirstName">Nombre</label>
              <span class="input__bar"></span>
            </div>

            <div class="input">
              <input type="text" name="apellido" id="signupLastName" minlength="2" required />
              <label for="signupLastName">Apellido</label>
              <span class="input__bar"></span>
            </div>

            <div class="input">
              <input type="email" name="correo" id="signupEmail" required />
              <label for="signupEmail">Correo</label>
              <span class="input__bar"></span>
            </div>

            <div class="input">
              <input type="tel" name="telefono" id="signupPhone" pattern="[0-9]{7,15}" />
              <label for="signupPhone">Tel√©fono</label>
              <span class="input__bar"></span>
            </div>

            <div class="input">
              <select id="signupRole" name="rol" required>
                <option value="" selected></option>
                <option value="cliente">Cliente</option>
                <option value="desarrollador">Desarrollador</option>
              </select>
              <label for="signupRole">Rol</label>
              <span class="input__bar"></span>
            </div>

            <div class="input" id="cargoField" style="display:none;">
              <input type="text" name="cargo" id="signupCargo" minlength="2" />
              <label for="signupCargo">Cargo (solo desarrollador)</label>
              <span class="input__bar"></span>
            </div>

            <div class="input">
              <input type="password" name="password" id="signupPassword" minlength="6" required />
              <label for="signupPassword">Contrase√±a</label>
              <span class="input__bar"></span>
              <button class="input__toggle" type="button" aria-label="Mostrar/ocultar contrase√±a"></button>
            </div>
          </div>

          <button class="btn" type="submit">Registrarme</button>

          <p class="form__switch">
            ¬øYa tienes cuenta?
            <button class="link link--btn" type="button" data-switch="login">Inicia sesi√≥n</button>
          </p>
        </form>
      </div>

      <!-- Columna: panel -->
<div class="auth__panel">
  <div class="panel__inner">
    <img src="./static/img/logo.png" 
        alt="Logo del Proyecto" 
        class="logo-proyecto" />

    <h1 class="titulo-proyecto">
      Bienvenido a <span>Code_Craft</span>
    </h1>
    <p class="subtexto">Crea, desarrolla y transforma tus ideas en c√≥digo</p>
  </div>
</div>


  <style>
 .logo-proyecto {
  max-width: 70%;
  height: auto;
  display: block;
  margin: 0 auto 20px;
}

/* Estilo del t√≠tulo */
.titulo-proyecto {
  font-family: 'Montserrat', sans-serif;
  font-size: 2.2rem;
  font-weight: 500;
  text-align: center;
  color: #e0e0e0;
  margin: 0;
  line-height: 1.3;
}

/* Parte destacada */
.titulo-proyecto span {
  display: block;
  font-size: 3rem;
  font-weight: 700;
  background: linear-gradient(90deg, #00c6ff, #007bff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: 1.5px;
  margin-top: 5px;
  text-shadow: 0 0 10px rgba(0, 123, 255, 0.7),
               0 0 20px rgba(0, 198, 255, 0.5);
}

/* Subtexto opcional */
.subtexto {
  text-align: center;
  font-family: 'Montserrat', sans-serif;
  font-size: 1rem;
  color: #aaa;
  margin-top: 10px;
}

  </style>
    </div>
  </main>

  <!-- Tu script de login.js si tiene l√≥gica visual/animaciones -->
  <script src="{{ url_for('static', filename='js/login.js') }}"></script>

  <!-- Script nuevo: control de intentos y bloqueo con SweetAlert2 + redirecci√≥n fiable -->
  <script>
    // ---------- Config ----------
    const MAX_ATTEMPTS = 5;
    const BASE_BLOCK_MINUTES = 5; // 1er bloqueo = 5 min, luego se duplica (cliente mantiene blockCount)
    const STORAGE_PREFIX = "loginState_"; // clave en localStorage

    // ---------- Helpers ----------
    function stateKey(user) { return STORAGE_PREFIX + user.toLowerCase(); }

    function loadState(user) {
      if (!user) return { attempts: 0, blockCount: 0, blockedUntil: 0 };
      const raw = localStorage.getItem(stateKey(user));
      return raw ? JSON.parse(raw) : { attempts: 0, blockCount: 0, blockedUntil: 0 };
    }

    function saveState(user, state) { localStorage.setItem(stateKey(user), JSON.stringify(state)); }

    function clearState(user) { localStorage.removeItem(stateKey(user)); }

    function computeBlockMinutes(blockCount) {
      return BASE_BLOCK_MINUTES * Math.pow(2, blockCount || 0);
    }

    function msToTime(ms) {
      const totalSec = Math.max(0, Math.floor(ms / 1000));
      const min = Math.floor(totalSec / 60);
      const sec = totalSec % 60;
      return `${min}m ${sec}s`;
    }

    // ---------- UI & l√≥gica ----------
    document.addEventListener("DOMContentLoaded", () => {
      const loginForm = document.getElementById("loginForm");
      const loginUsuario = document.getElementById("loginUsuario");
      const loginPassword = document.getElementById("loginPassword");
      const loginBtn = document.getElementById("loginBtn");
      const togglePass = document.getElementById("togglePassword");

      // Mostrar/ocultar contrase√±a simple
      togglePass?.addEventListener("click", () => {
        if (loginPassword.type === "password") {
          loginPassword.type = "text";
          togglePass.textContent = "üôà";
        } else {
          loginPassword.type = "password";
          togglePass.textContent = "üëÅ";
        }
      });

      // Si el usuario tiene bloqueo activo al cargar (si ya escribi√≥ su usuario)
      loginUsuario.addEventListener("blur", () => {
        const user = loginUsuario.value.trim();
        if (!user) return;
        const st = loadState(user);
        if (st.blockedUntil && Date.now() < st.blockedUntil) {
          const remaining = st.blockedUntil - Date.now();
          Swal.fire({
            icon: "error",
            title: "Cuenta bloqueada",
            html: `Esta cuenta est√° bloqueada. Tiempo restante: <b>${msToTime(remaining)}</b>.`,
          });
          loginBtn.disabled = true;
        } else {
          loginBtn.disabled = false;
        }
      });

      (function checkOnLoad() {
        const user = loginUsuario.value.trim();
        if (!user) return;
        const st = loadState(user);
        if (st.blockedUntil && Date.now() < st.blockedUntil) {
          const remaining = st.blockedUntil - Date.now();
          Swal.fire({
            icon: "error",
            title: "Cuenta bloqueada",
            html: `Esta cuenta est√° bloqueada. Tiempo restante: <b>${msToTime(remaining)}</b>.`,
          });
          loginBtn.disabled = true;
        }
      })();

      // Submit manejado con fetch (AJAX) para obtener respuesta y redirigir correctamente
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const user = loginUsuario.value.trim();
        const pass = loginPassword.value;

        if (!user) {
          Swal.fire("Error", "Ingresa tu usuario o correo", "warning");
          return;
        }

        const st = loadState(user);
        // Si est√° bloqueado en localStorage
        if (st.blockedUntil && Date.now() < st.blockedUntil) {
          const remaining = st.blockedUntil - Date.now();
          Swal.fire("Cuenta bloqueada", `Tiempo restante: ${msToTime(remaining)}`, "error");
          return;
        }

        // deshabilitar bot√≥n mientras se procesa
        loginBtn.disabled = true;
        loginBtn.textContent = "Validando...";

        try {
          // Enviamos como form-urlencoded y marcamos X-Requested-With 
          const body = new URLSearchParams();
          body.append("usuario", user);
          body.append("password", pass);

          const res = await fetch("/login", {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "Content-Type": "application/x-www-form-urlencoded"
            },
            body: body.toString(),
            credentials: 'same-origin' // importante para que la cookie de sesi√≥n se guarde
          });

          // 1) Si el servidor realiz√≥ redirecci√≥n (Flask -> redirect)
          // fetch sigue el redirect autom√°ticamente; res.redirected ser√° true si hubo redirecci√≥n
          if (res.redirected) {
            // res.url contiene la URL final (ej. http://127.0.0.1:5000/cliente)
            await Swal.fire({ icon: "success", title: "¬°Bienvenido!", text: "Inicio de sesi√≥n exitoso", confirmButtonText: "Continuar" });
            window.location.href = res.url;
            return;
          }

          // 2) Si no hubo redirecci√≥n, intentamos leer JSON (caso en que tu backend devuelva JSON para AJAX)
          const ct = res.headers.get("content-type") || "";
          if (ct.includes("application/json")) {
            const data = await res.json();
            if (data.status === "success") {
              clearState(user);
              await Swal.fire({ icon: "success", title: "¬°Bienvenido!", showConfirmButton: false, timer: 900 });
              // preferir redirect que env√≠e el servidor, si viene
              window.location.href = data.redirect || "/";
              return;
            }

            if (data.status === "blocked") {
              // sincronizar bloqueo en cliente
              const blockedUntil = data.blocked_until ? new Date(data.blocked_until).getTime() : (Date.now() + BASE_BLOCK_MINUTES * 60000);
              st.blockedUntil = blockedUntil;
              saveState(user, st);
              const remaining = blockedUntil - Date.now();
              Swal.fire("Cuenta bloqueada", `Bloqueo hasta: <b>${new Date(blockedUntil).toLocaleString()}</b><br>Tiempo restante: <b>${msToTime(remaining)}</b>`, "error");
              setTimeout(()=> location.reload(), 1200);
              return;
            }

            // si llegamos aqu√≠, data.status === 'error'
            st.attempts = (st.attempts || 0) + 1;
            if (st.attempts >= MAX_ATTEMPTS) {
              const durationMin = computeBlockMinutes(st.blockCount || 0);
              st.blockCount = (st.blockCount || 0) + 1;
              st.blockedUntil = Date.now() + durationMin * 60 * 1000;
              st.attempts = 0;
              saveState(user, st);
              Swal.fire({ icon: "error", title: "Demasiados intentos", html: `Has superado ${MAX_ATTEMPTS} intentos. Tu cuenta quedar√° bloqueada por <b>${durationMin} minutos</b>.` }).then(()=> location.reload());
              return;
            } else {
              saveState(user, st);
              const left = MAX_ATTEMPTS - st.attempts;
              Swal.fire({ icon: "warning", title: "Inicio de sesi√≥n fallido", html: `${data.message || "Usuario o contrase√±a incorrectos."} <br>Te quedan <b>${left}</b> intento(s).` });
              return;
            }
          }

          // 3) Fallback: no redirect, no JSON -> probablemente HTML con mensaje. Leer texto y mostrarlo.
          const txt = await res.text();
          // si el texto incluye la cadena de error que usas en backend, mostrarla
          if (txt && (txt.includes("Usuario o contrase√±a incorrectos") || txt.toLowerCase().includes("incorrect"))) {
            st.attempts = (st.attempts || 0) + 1;
            if (st.attempts >= MAX_ATTEMPTS) {
              const durationMin = computeBlockMinutes(st.blockCount || 0);
              st.blockCount = (st.blockCount || 0) + 1;
              st.blockedUntil = Date.now() + durationMin * 60 * 1000;
              st.attempts = 0;
              saveState(user, st);
              Swal.fire({ icon: "error", title: "Demasiados intentos", html: `Has superado ${MAX_ATTEMPTS} intentos. Tu cuenta quedar√° bloqueada por <b>${durationMin} minutos</b>.` }).then(()=> location.reload());
            } else {
              saveState(user, st);
              const left = MAX_ATTEMPTS - st.attempts;
              Swal.fire({ icon: "warning", title: "Inicio de sesi√≥n fallido", html: `Usuario o contrase√±a incorrectos. <br>Te quedan <b>${left}</b> intento(s).` });
            }
          } else {
            // Mensaje inesperado: mostrar texto o mensaje gen√©rico
            Swal.fire({ icon: "error", title: "Error", text: txt || "Respuesta inesperada del servidor" });
          }

        } catch (err) {
          console.error(err);
          Swal.fire("Error", "Ocurri√≥ un error de conexi√≥n. Intenta de nuevo.", "error");
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = "Entrar";
        }
      });
    });
  </script>

  <!-- Mostrar/ocultar 'cargo' en signup -->
  <script>
    const rol = document.getElementById('signupRole');
    const cargoField = document.getElementById('cargoField');
    rol?.addEventListener('change', () => {
      cargoField.style.display = rol.value === 'desarrollador' ? 'block' : 'none';
    });
  </script>
</body>
</html>
